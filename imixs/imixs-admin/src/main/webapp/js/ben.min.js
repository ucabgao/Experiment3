"use strict";var BENJS=BENJS||{};BENJS.namespace=function(d){var c=d.split("."),b=BENJS,a;if(c[0]==="BENJS"){c=c.slice(1)}for(a=0;a<c.length;a+=1){if(typeof b[c[a]]==="undefined"){b[c[a]]={}}b=b[c[a]]}return b};BENJS.namespace("org.benjs.core");BENJS.org.benjs.core=(function(){console.debug("------------------------");console.debug("Ben.js: Version 0.3.0");console.debug("------------------------");var j="",c=new Array(),b=new Array(),g=new Array(),p=function(s){s=s||{};if(!s.id){console.error("createController wrong settings provided: id missing!");return false}console.debug("register new controller: '"+s.id+"'");var r=new e(s);c.push(r);return r},n=function(s){s=s||{};if(!s.id){console.error("createTemplate wrong settings provided: id missing!");return false}console.debug("register new template: '"+s.id+"' view='"+s.url+"'");var r=new h(s);b.push(r);return r},k=function(s){s=s||{};if(!s.id){console.error("createController wrong settings provided: id missing!");return false}console.debug("register new route: '"+s.id+"'");var r=new f(s);g.push(r);return r},l=function(s){var r;$.each(c,function(t,u){if(u.id===s){r=u;return false}});if(r){return r}else{console.error("ERROR: Controler '"+s+"' not registered")}},q=function(s){var r;$.each(b,function(t,u){if(u.id===s){r=u;return false}});if(r){return r}else{console.error("ERROR: Template'"+s+"' not registered")}},i=function(s,r){$(s).find(":input").each(function(){var u,v,t;v=$(this).attr("data-ben-model");if(v){v=v.trim();u="";switch(this.type){case"text":case"hidden":case"password":case"select-multiple":case"select-one":case"textarea":u=$(this).val();break;case"checkbox":case"radio":this.checked=false}if(v.match("^get[_a-zA-Z0-9.]+\\(")){try{v="set"+v.substring(3);t=v.substring(0,v.indexOf("("));if($.isFunction(r[t])){o(v,r,u)}else{console.warn("setter method '"+t+"' is not defined!")}}catch(w){console.error("Error calling setter-method '"+v+"' -> "+w.message)}}else{r[v]=u}}})},a=function(r){if(j){if(r.indexOf("?")>-1){r=r+"&appVersion="+j}else{r=r+"?appVersion="+j}}return r},o=function(w,s,t){var u,A,y,x,z,r,v;u=w.indexOf("(");A=w.substring(0,u);y=w.substring(u+1).trim();y=y.substring(0,y.indexOf(")")).trim();x=y.split(",");if(t){x.push(t)}$.each(x,function(B,C){if(C.indexOf("'")===0||C.indexOf('"')===0){x[B]=C.substring(1,C.length-1)}else{}});r=A.split(".");A=r.pop();for(v=0;v<r.length;v++){s=s[r[v]]}z=s[A];if(typeof z==="function"){return z.apply(s,x)}},m=function(t,w){var s,v,u,r;s=window;v=t.split(".");u=v.pop();for(r=0;r<v.length;r++){s=s[v[r]]}return new s[u](w)},d=function(r){console.debug("starting application...");if(r===undefined){r={}}if(r.loadTemplatesOnStartup===undefined){r.loadTemplatesOnStartup=true}if(r.appVersion===undefined){r.appVersion=""}console.debug("configuration=",r);j=r.appVersion;$.each(c,function(s,t){t.init()});if(r.loadTemplatesOnStartup){$.each(b,function(s,t){t.load()})}},e=function(r){r=r||{};var s=this;this.id=r.id;this.model=r.model;this.view=r.view;if(typeof r.autoRefresh=="undefined"){this.autoRefresh=true}else{this.autoRefresh=r.autoRefresh}this.foreachCache=new Array();this.beforePush=$.Callbacks();this.afterPush=$.Callbacks();this.beforePull=$.Callbacks();this.afterPull=$.Callbacks();if(typeof r.beforePush==="function"){this.beforePush.add(r.beforePush)}if(typeof r.afterPush==="function"){this.afterPush.add(r.afterPush)}if(typeof r.beforePull==="function"){this.beforePull.add(r.beforePull)}if(typeof r.afterPull==="function"){this.afterPull.add(r.afterPull)}this.init=function(u){this.foreachCache=new Array();var t="[data-ben-controller='"+this.id+"']";if($(t,u).length){console.debug("controller: '"+this.id+"' init...");if(s.view){s.load(s.view,u)}else{s.push(u)}}};this.push=function(v){var u="[data-ben-controller='"+this.id+"']",t=$(u,v);console.debug("controller: '"+s.id+"' -> push model=",s.model);s.beforePush.fire(s,t);$(t).each(function(){s._update(this,s.model)});s.afterPush.fire(s,t)};this.pull=function(){var u="[data-ben-controller='"+this.id+"']",t=$(u);s.beforePull.fire(s,t);i(u,this.model);console.debug("pull model from view '"+this.id+"': Model=",this.model);s.afterPull.fire(s,t)};this.refresh=function(t){s.pull();s.push()};this.load=function(t,v){this.foreachCache=new Array();if(!t){if(s.view){t=s.view}}if(t){var u="[data-ben-controller='"+this.id+"']";t=a(t);$(u,v).each(function(){console.debug("controller: '"+s.id+"' -> load '"+t+"'...");var w=$(this).parent();$(this).load(t,function(y,x,z){if(x==="error"){$(this).prepend("<!-- WARNING controller-view '"+t+"' not found -->");console.debug("controller-view '"+t+"' not found!");s.push(w)}else{s.push(w)}})})}};this._update=function(t,u){$(t).find("[data-ben-render]").each(function(){var w,v,x;w=$(this).attr("data-ben-render");v=$(this).closest("[data-ben-foreach]");x=$(t).closest("[data-ben-foreach]");if(v.length===0||$(v).get(0)===$(x).get(0)){s._render_element(this,w,u)}else{}});$(t).find("[data-ben-foreach]").each(function(){var v;v=$(this).attr("data-ben-foreach-id");if(!v){v=s.foreachCache.length;$(this).attr("data-ben-foreach-id",v);s.foreachCache.push("")}});$(t).find("[data-ben-model]").each(function(){var w,v,x;w=$(this).attr("data-ben-model");v=$(this).closest("[data-ben-foreach]");x=$(t).closest("[data-ben-foreach]");if(v.length===0||$(v).get(0)===$(x).get(0)){s._update_element(this,w,u)}else{}});$(t).find("[data-ben-foreach]").each(function(){var B,y,w,C,v,x,A,z;y=$(this).attr("data-ben-foreach");w=$(this).attr("data-ben-foreach-id");if(y.indexOf(" as ")>-1){A=y.split(" ");y=A[0].trim();z=A[2].trim()}B=$(this).parent("[data-ben-foreach]");C=s._extract_model_value(y,u);if(B.length===0&&C&&$.isArray(C)){v=$(this);if(w){if(w>=s.foreachCache.length){console.debug("WARNING - wrong foreachCach length!")}x=s.foreachCache[w]}if(!x){console.debug("caching foreach block: "+w);x=v.clone().html().trim();if(x.indexOf("<")!=0||!$(x).html()){x="<span>"+x+"</span>"}s.foreachCache[w]=x}$(this).empty();if($.isArray(C)){$.each(C,function(D,E){var F;if(z){E=m(z,E)}F=$.parseHTML(x);$(F).attr("data-ben-entry",D);$(v).append(F);s._update(F,E)})}}})};this._update_element=function(t,x,w){var y,v,u;if(x){if(x.match("^::")){v=x.indexOf("::",2);y=x.substring(2,v);x=x.substring(v+2)}u=s._extract_model_value(x,w);if(y){$(t).attr(y,u)}else{if(!t.type&&$(t).text){$(t).html(u)}else{switch(t.type){case"text":case"hidden":case"password":case"select-multiple":case"select-one":case"textarea":$(t).val(u);break;case"checkbox":case"radio":$(t).checked=false}}}}};this._render_element=function(t,w,v){var u;if(w){u=s._extract_model_value(w,v);if(u){$(t).show()}else{$(t).hide()}}};this._extract_model_value=function(w,v){var u,t;if(w){w=w.trim();if(w.indexOf("(")>-1){if(w.match("^[_a-zA-Z0-9.]+\\(")){try{t=w.substring(0,w.indexOf("("));u=o(w,v)}catch(x){console.error("Error calling gettermethod '"+w+"' -> "+x.message)}}else{console.error("Error invalid method call -> "+w)}}else{if(w==="."){u=v}else{u=v[w]}}if((typeof(u)==="undefined")){u=""}return u}}},h=function(r){r=r||{};var s=this;this.id=r.id;this.url=r.url;this.beforeLoad=$.Callbacks();this.afterLoad=$.Callbacks();if(typeof r.beforeLoad==="function"){this.beforeLoad.add(r.beforeLoad)}if(typeof r.afterLoad==="function"){this.afterLoad.add(r.afterLoad)}this.load=function(t){if(t){s.url=t}if(!s.url){console.debug("Warning: temlate '"+s.id+"' can't be loaded: no url defined!");return false}var u="[data-ben-template='"+s.id+"']";s.url=a(s.url);$(u).each(function(){console.debug("template: '"+s.id+"' -> load '"+s.url+"'...");s.beforeLoad.fire(s,$(this));$(this).load(s.url,function(w,v,z){var x,y=$(this);if(v==="error"){x="Error loading template '"+s.url+"': not found";console.error(x);$(this).prepend("<!-- "+x+" -->")}else{console.debug("template: '"+s.id+"' loaded");$(y).find("[data-ben-controller]").each(function(){var A=BENJS.org.benjs.core.findControllerByID($(this).attr("data-ben-controller"));if(A&&A.autoRefresh===true){A.init(y)}})}s.afterLoad.fire(s,$(y))})})}},f=function(r){r=r||{};var s=this;this.id=r.id;this.templates=r.templates;this.beforeRoute=$.Callbacks();this.afterRoute=$.Callbacks();this.templateCount=0;if(typeof r.beforeRoute==="function"){this.beforeRoute.add(r.beforeRoute)}if(typeof r.afterRoute==="function"){this.afterRoute.add(r.afterRoute)}this.route=function(){console.debug("route: '"+s.id+"'...");s.beforeRoute.fire(s);var t=Object.keys(s.templates);$.each(t,function(u,v){var w=BENJS.org.benjs.core.findTemplateByID(v);if(w){s.templateCount++;w.afterLoad.add(s._templateOnLoad);w.load(s.templates[v],false)}})};this._templateOnLoad=function(t){t.afterLoad.remove(s._templateOnLoad);s.templateCount--;if(s.templateCount===0){document.location.href="#"+s.id;console.debug("route: '"+s.id+"' complete");s.afterRoute.fire(s)}}};return{start:d,createController:p,createTemplate:n,createRoute:k,findControllerByID:l,findTemplateByID:q}}());